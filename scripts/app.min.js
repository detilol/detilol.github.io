;(function(){
	'user strict';
	angular.module('detilolSite', ['ui.router', 'ui.bootstrap', 'ngAnimate', 'ngResource'])
		.controller('PageCtrl', PageCtrl)
		.controller('BlogCtrl', BlogCtrl)
		.constant('L', L)
		.config(config);
	
	config.$inject = ['$stateProvider', '$urlRouterProvider', '$locationProvider'];

	PageCtrl.$inject = ['$scope', 'BLOBS'];

/**
 * Configure the Routes
 */
function config($stateProvider, $urlRouterProvider, $locationProvider) {
	
	$urlRouterProvider.otherwise('/404');
	
	$stateProvider
		.state('home', {url:'/', templateUrl: 'partials/home.html', controller: 'PageCtrl'})		
		.state('about', {url:'/about', templateUrl: 'partials/about.html', controller: 'PageCtrl'})
		.state('klasses', {url:'/klasses', templateUrl: 'partials/klasses.html', controller: 'PageCtrl'})
		.state('childcare', {url:'/childcare', templateUrl: 'partials/childcare.html', controller: 'PageCtrl'})
		.state('pricing', {url:'/pricing', templateUrl: 'partials/pricing.html', controller: 'PageCtrl'})
		.state('contact', {url:'/contact', templateUrl: 'partials/contact.html', controller: 'MapCtrl'})
		.state('404', {url:'/404', templateUrl: 'partials/404.html', controller: 'PageCtrl'});
	
	$locationProvider.html5Mode({
        enabled:true,
        requireBase: true
    });

    $locationProvider.hashPrefix('!');
      
    // Don't strip trailing slashes from calculated URLs
    //  $resourceProvider.defaults.stripTrailingSlashes = false;
};

/**
 * Controls the Blog
 */
function BlogCtrl() {
  console.log("Blog Controller reporting for duty.");
};

/**
 * Controls all other Pages
 * @param $scope
 * @param BLOBS constant links to BLOB resources (images, video) whether in cloud or local
 */
function PageCtrl($scope, BLOBS) {
  $scope.blobs = BLOBS;
 
  //googleSpreadsheetsService.loadWorksheet(GS_ID);
  /*
  // Activates the Carousel
  $('.carousel').carousel({
    interval: 5000
  });
  // Activates Tooltips for Social Links
  $('.tooltip-social').tooltip({
    selector: "a[data-toggle=tooltip]"
  })
  */
}


})();
;(function(){
	'user strict';
	angular.module('detilolSite')
		.controller('CarouselCtrl', CarouselCtrl);
	
	CarouselCtrl.$inject = ['$scope'];
	function CarouselCtrl($scope){
		$scope.myInterval = 5000;
		$scope.noWrapSlides = false;
		$scope.slides = [
		   {
			   image: '//placekitten.com/601/300',
			   text: 'Kitty'
		   },
		   {
			   image: '//placekitten.com/602/300',
			   text: 'Мурка'
		   },
		   {
			   image: '//placekitten.com/603/300',
			   text: 'Васька'
		   },
		];
	}
})();
;(function(){
	'user strict';
	
	angular.module('detilolSite')
		.directive('googleSheet', ['googleSheetsService', function(googleSheetsService){
		var directive = {
			restrict: 'AE',
			transclude:true,
			scope:{
				worksheet:'@',
				sheet:'@'
			},			
			link:link,
			controller:function($scope){
				var vm = this;
				vm.data = googleSheetsService.getSheet($scope.worksheet, $scope.sheet);				
			},
			controllerAs:'gs'
		};
		
		return directive;
		
		function link(scope, element, attrs, controller, transclude){
			transclude(scope, function(clone, scope) {
		        element.append(clone);
		     });
		}
		
		
	}]);
})();
;(function(){
	'use strict';
	angular
		.module('detilolSite')
		.value('gs', {
			cellfeedSchema:'http://schemas.google.com/spreadsheets/2006#cellsfeed',
			feedsHostname: 'spreadsheets.google.com',
			worksheetFeed: '/feeds/worksheets/',
			cellFeed: '/feeds/cells/',
			worksheetFeedSuffix: '/public/full?alt=json',
			worksheetFeedUrlTemplate: 'http://spreadsheets.google.com/feeds/worksheets/:worksheetId/public/full'
		})
		.factory('googleSheetsService', GoogleSheetsService);
	
	GoogleSheetsService.$inject = ['$http', '$log', '$q', '$resource', 'gs'];
	
	function GoogleSheetsService($http, $log, $q, $resource, gs){
		var gsData = {};
		var worksheetsPromised = {};
	    var service = {	    		
	        getSheet:getSheet
	    };	    
	    return service;
	    
	    ///////////////////////////////////////////////////////////////
	    function getSheet(worksheet, sheet){
	    	if(!worksheetsPromised[worksheet]){
	    		worksheetsPromised[worksheet] = _getWorksheetPromise(worksheet);
	    	}
	    	gsData[worksheet] = gsData[worksheet] || {};
	    	if(gsData[worksheet][sheet]){
	    		return gsData[worksheet][sheet].data
	    	}else{
	    		gsData[worksheet][sheet] = {data:[['загрузка ...']]};
	    		loadSheet(worksheetsPromised[worksheet], worksheet, sheet);
	    		return gsData[worksheet][sheet].data;
	    	}
	    }
	    	
	    function loadSheet(worksheetPromise, worksheet, sheet){
	    	worksheetPromise
	    		.then(_registerWorksheet)
	    		.then(function(){
	    			var jsonApiUrl = gsData[worksheet][sheet].href;
	    			_getCellsPromise(worksheet, sheet)
	    				.then(_parseCells)
	    				.then(function(table){
	    					angular.copy(table, gsData[worksheet][sheet].data);
	    				}).
	    				catch(function(error){
	    					$log.error(error);
	    					gsData[worksheet][sheet].error = error;
	    				});
	    		});
	    }
	    
	    /**
	     * There are may be many sheets at once on a page and to avoid them
	     * simultaneously making request about worksheet's feed we register only one request
	     * in promise-registry and if exists - return the same promise for all requests. 
	     * @return promise of feed (response.data.feed) and worksheetId: {worksheedId, feed}
	     */
	    function _getWorksheetPromise(worksheet){	    	
	    	var WorksheetFeed = $resource(
	    			gs.worksheetFeedUrlTemplate,
	    			{
	    				worksheetId:worksheet,
	    				alt:'json-in-script',
	    				callback:'JSON_CALLBACK'
	    			},
	    			{
	    				getMetadata:{
	    					method:'JSONP'
	    				}
	    			}
	    	);
	    	
	    	return WorksheetFeed.getMetadata().$promise.then(function(data){
	    		return {worksheetId:worksheet, feed:data.feed};
	    	});
	    	
	    	/*
	    	var url = 'http://'+gs.feedsHostname+gs.worksheetFeed+worksheet+gs.worksheetFeedSuffix;
	    	return $http({url:url, method:'GET'})
	    		.then(function(response){
	    			return {worksheetId:worksheet, feed:response.data.feed};
	    		});
	    	*/
	    }
	    
	    function _getCellsPromise(worksheet, sheet){
	    	var jsonApiUrl = gsData[worksheet][sheet].href;
	    	var CellsFeed = $resource(
	    			jsonApiUrl,
	    			{
	    				alt:'json-in-script',
	    				callback:'JSON_CALLBACK'
	    			},
	    			{
	    				getCells:{
	    					method:'JSONP'
	    				}
	    			}
	    	);
	    	return CellsFeed.getCells().$promise;
	    }
	    /**
	     * 
	     * @param feedInfo {worksheedId, feed}
	     * @returns
	     */
	    function _registerWorksheet(feedInfo){
	    	gsData[feedInfo.worksheetId] = gsData[feedInfo.worksheetId] || {};
	    	var worksheetInfo = gsData[feedInfo.worksheetId];
	    	for(var i=0; i<feedInfo.feed.entry.length; i++){
	    		var sheet = feedInfo.feed.entry[i];
	    		var sheetId = sheet.title.$t;
	    		worksheetInfo[sheetId] = worksheetInfo[sheetId] || {};
				var link = sheet.link;				
				for(var k=0; k<link.length; k++){
					if(link[k].rel === gs.cellfeedSchema){						
						worksheetInfo[sheetId].href = link[k].href;
						break;
					}
				}				
			}
	    	return gsData;
	    }
	    
	    function _parseCells(data){
	    	var feed = data.feed;
	    	if(!feed) throw new Error('cells feed is empty');
	    	if( !feed.entry ){
	    		throw new Error('cells feed for \"'+feed.title.$t+'\": the table is empty');
	    	}
			var table = [];
			var maxColumn = 0;
			var lastRow = 0;
			for(var i=0; i<feed.entry.length; i++){
				var entry = feed.entry[i];
				var rowIndex = entry.gs$cell.row-1;				
				if(lastRow+1<rowIndex){
					for(var r=lastRow+1;r<rowIndex;r++){
						table[r] = [];
					}
				}
				if(table.length<entry.gs$cell.row){
					table[rowIndex] = [];
					lastRow = rowIndex;
				}
				
				var row = table[rowIndex];
				var currentColNum = entry.gs$cell.col;
				if(currentColNum>maxColumn) maxColumn=currentColNum;
				if(row.length<maxColumn){
					for(var k=0; k<maxColumn; k++){
						row[k] = row[k] || '';
					}
				}
				var colIndex = currentColNum-1;
				row[colIndex] = entry.gs$cell.$t;
			}
			return table;
	    }
	    	    

	};
})();
;(function(){
	'use strict';
	angular
		.module('detilolSite')
		.factory('helloService', HelloService);
	
	function HelloService(){
		var service = {
			sayHello : sayHello
		};
		return service;
		
		function sayHello(){
			return 'Hello world!';
		}
	      
	};
})();
;(function(){
	'user strict';
	angular.module('detilolSite')
		.controller('MapCtrl', MapCtrl);
	
	MapCtrl.$inject = ['L'];
	function MapCtrl(L){
		//var map = L.map('map').setView([55, 37], 13);
	/*
		L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6IjZjNmRjNzk3ZmE2MTcwOTEwMGY0MzU3YjUzOWFmNWZhIn0.Y8bhBaUMqFiPrDRW9hieoQ', {
			maxZoom: 18,
			attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
				'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
				'Imagery © <a href="http://mapbox.com">Mapbox</a>',
			id: 'mapbox.streets'
		}).addTo(map);
	
		L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
		    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
		}).addTo(map);
	
		L.marker([55.8234706794, 37.3707702755]).addTo(map)
			.bindPopup("<b>Hello world!</b><br />I am a popup.").openPopup();
	
		
		var popup = L.popup();
	
		function onMapClick(e) {
			popup
				.setLatLng(e.latlng)
				.setContent("You clicked the map at " + e.latlng.toString())
				.openOn(map);
		}
	
		map.on('click', onMapClick);
	*/
		 var myMap = L.map('map', {scrollWheelZoom: true, zoomControl: false});
		  var osmUrl = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
		  var osmAttrib = 'Map data © OpenStreetMap contributors';
		  var osm = new L.TileLayer(osmUrl, {minZoom: 0, maxZoom: 20, attribution: osmAttrib});
		  myMap.setView(new L.LatLng(55.8234706794, 37.3707702755), 15);
		  myMap.addLayer(osm);
		  myMap.addControl(L.control.zoom({position: 'bottomleft'}));
		  
		  var greenIcon = L.icon({
			    iconUrl: '../img/leaf-green.png',
			    shadowUrl: '../img/leaf-shadow.png',
	
			    iconSize:     [38, 95], // size of the icon
			    shadowSize:   [50, 64], // size of the shadow
			    iconAnchor:   [22, 94], // point of the icon which will correspond to marker's location
			    shadowAnchor: [4, 62],  // the same for the shadow
			    popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
			});
		  
		  //55.8234706794, 37.3707702755
		  L.marker([55.8234, 37.37078], {icon:greenIcon}).addTo(myMap)
			.bindPopup("<strong>&#x263a; Улыбашки!</strong>", {closeButton:false}).openPopup();
	}
})();
;(function(){
	'use strict';
	angular
		.module('detilolSite')
		.factory('timetableService', TimetableService);
	
	TimetableService.$inject = ['$http', '$log', '$q'];
	
	function TimetableService($http, $log, $q){
		var data = null;
	    var service = {	    		
	        getData: getData,
	        getTimetable: getTimetable
	    };
		
		getData('/data/timetable.json').then(function(response){
			data = response.data;
		});
		
	    return service;
	    /**
	     * @param url http get URL
	     * @return promise
	     */
	    function getData(url){
	    	if(!url){
	    		var promise = $q(function(resolve, reject){
	    			setTimeout(function(){
	    				var errorData = {data:{message:{title:'Not found', text:'URL is not defined'}}, status:404};
		    			reject(errorData);
	    			}, 0);	    			
	    		});
	    		return promise;
	    	}
	    	return $http.get(url);	    	
	    }
	    
	    function getTimetable(){
	    	return data;
	    }
	};
})();